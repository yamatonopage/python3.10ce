name: Build CeGCC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install --no-install-recommends -y \
            git build-essential bison flex m4 \
            libgmp-dev libmpc-dev libmpfr-dev texinfo

      - name: Clone cegcc-build & wincepython3
        run: |
          git clone --recursive --depth 1 https://github.com/MaxKellermann/cegcc-build.git
          git clone https://github.com/brain-hackers/cpython-wince.git
      - name: Create install and build directories
        run: |
          mkdir -p /tmp/cegcc-output
          mkdir -p $HOME/cegcc-install

      - name: Build CeGCC
        run: |
          cd /tmp/cegcc-output
          $GITHUB_WORKSPACE/cegcc-build/build.sh -j$(nproc) --prefix=$HOME/cegcc-install

      - name: Build PythonCE and pack
        run: |
          cd $GITHUB_WORKSPACE/cpython-wince
          ./ce_build.sh
          ./ce_pack.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wince_build
          path: cegcc-build/wince_build/
